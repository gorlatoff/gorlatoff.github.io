# Спецификация проекта JI Analyzer

## Общее описание

Инструмент для анализа музыкальной гармонии в натуральном строе (Just Intonation). Интерпретирует MIDI-ноты как рациональные дроби (p/q), визуализируя акустические взаимосвязи аккордов.

**Ключевая проблема:** Многозначность. Одной клавише соответствуют десятки дробей (6/5, 7/6, 19/16...). Алгоритм выбирает оптимальный вариант по глобальной структуре аккорда.

------

## Эволюция алгоритма (тезисно)

| Версия | Подход                                  | Проблема                                            |
| ------ | --------------------------------------- | --------------------------------------------------- |
| v1     | Попарная консонантность (Euler, Tenney) | Не видит структуру аккорда целиком                  |
| v2     | GCD/LCM с `getOddPart()`                | 7-limit побеждал 5-limit (степени 2 игнорировались) |
| v3     | GCD/LCM полные числа + Prime Limit      | ✓ Рабочая версия                                    |

**Критический инсайт v2→v3:**

text



```
5-limit мажор: 1/1, 9/8, 5/4, 4/3, 3/2, 5/3, 15/8
  → LCM(odd) = 45, LCM(full) = 180

7-limit: 1/1, 8/7, 5/4, 4/3, 32/21, 5/3, 40/21  
  → LCM(odd) = 5 ← ложный победитель!
  → LCM(full) = 3360 ← правильно проигрывает
```

------

## Текущая архитектура (v3)

### 1. Метрика сложности

JavaScript



```
Score = (LCM(nums) / GCD(dens)) × (LCM(dens) / GCD(nums))^gcdWeight
```

| Параметр          | Значение              | Смысл                                         |
| ----------------- | --------------------- | --------------------------------------------- |
| `gcdWeight`       | 1.0–3.0 (default 1.5) | Вес фундамента vs cover                       |
| `PRIME_LIMIT`     | 7                     | Отсекает 11/8, 13/8 и т.д.                    |
| `CENTS_THRESHOLD` | 35                    | Фильтр четвертьтонов (7/4 проходит, 11/6 нет) |

**Важно:** `ignoreOctaves = false` — степени 2 учитываются!

### 2. Фильтрация кандидатов

JavaScript



```
for (n/d) in all_ratios:
  if gcd(n,d) ≠ 1: skip           // Несократимые
  if oddPart > maxOdd: skip       // Odd Limit (default 45)
  if maxPrime(n,d) > 7: skip      // Prime Limit — КРИТИЧНО!
  if |cents - 12EDO| > 35: skip   // Не четвертьтона
  
  candidates[step].push({n, d, weight: eulerGradus(n,d)})
```

**Сортировка по Euler Gradus** — фиксирует порядок на экране и tiebreaker.

### 3. Beam Search

text



```
1. Для каждой потенциальной тоники:
   - Beam width = 50
   - На каждом шаге: расширяем все лучи всеми кандидатами
   - Пересчитываем computeWeightedComplexity()
   - Оставляем top-50

2. Hysteresis: не менять тонику если улучшение < порога (default 20%)

3. Результат: набор дробей + тоника с минимальным Score
```

### 4. Визуализация

**Hint Bar (над клавишами):**

- Цвет = Euler Gradus лучшего кандидата (зелёный → красный)
- Alpha: активные 0.85, неактивные 0.45, тоника 1.0
- Маркеры: ◆ (синий) = GCD/Fundamental, ▲ (жёлтый) = LCM/Cover

**На клавишах:**

- Активные: до 4 альтернатив, alpha = 0.25 + 0.35 × (best/current)
- Призраки: до 3 альтернатив, alpha = 0.4 × ratio²
- Порядок фиксирован (по Euler), меняется только alpha

**Analysis Bar:**

- Cover (LCM): значение + Hz + нота (например: `180 | 1760.0Hz ≈ A6`)
- Fundamental (GCD): значение + Hz + нота

### 5. Режимы тоники

| Режим  | Поведение                             | UI                 |
| ------ | ------------------------------------- | ------------------ |
| Auto   | Перебор всех нот, выбор лучшего Score | Checkbox           |
| Manual | ПКМ фиксирует 1/1                     | ПКМ отключает Auto |

**Hysteresis:** Не менять тонику если новый Score лучше менее чем на N% (слайдер 0–50%).

------

## Ключевые формулы

**Частота фундамента:**

JavaScript



```
tonicHz = 440 × 2^((tonicMidi - 69) / 12)
gcdHz = tonicHz / LCM(nums)    // Низкая нота
lcmHz = tonicHz × LCM / GCD    // Высокая нота
```

**Euler Gradus:**

JavaScript



```
G(n/d) = 1 + Σ((p-1) × k) для всех p^k в факторизации n×d
// G(3/2) = 1 + (3-1) + (2-1) = 4
// G(5/4) = 1 + (5-1) + (2-1)×2 = 7
// G(7/4) = 1 + (7-1) + (2-1)×2 = 9
```

------

## Решённые проблемы

| Проблема                       | Решение                            |
| ------------------------------ | ---------------------------------- |
| 7-limit побеждает 5-limit      | Полные числа в метрике             |
| Большие простые (19/16, 11/8)  | Prime Limit = 7 + Euler сортировка |
| Скачущие позиции интерпретаций | Фиксированный порядок по Euler     |
| Тоника "прыгает"               | Hysteresis (порог смены)           |
| Нет баланса LCM/GCD            | gcdWeight слайдер                  |

------

## Нюансы и ловушки

### Prime Limit vs Odd Limit

- **Odd Limit 45** пропускает 11/8 (odd=11), 13/8 (odd=13)
- **Prime Limit 7** их отсекает — это правильное поведение!

### Октавы в расчётах

- **Score:** Полные числа (9/8 ≠ 9/4)
- **Генерация:** Только [1,2), потом `adjustRatioOctave()`
- **LCM/GCD маркеры:** Показываются во всех октавах клавиатуры

### Hysteresis

При быстрой игре тоника может "прыгать". Hysteresis=20% означает: не менять тонику, если новый Score лучше менее чем на 20%.

------

## API ji-lib.js

JavaScript



```
jiLib = {
  // Core
  gcd, lcm, gcdArray, lcmArray, getOddPart,
  getMaxPrime(n),                              // Для Prime Limit
  
  // Ratios  
  createRatio(n, d),
  adjustRatioOctave(r, shift),
  
  // Complexity
  computeComplexity(ratios, useLCM, useGCD, ignoreOctaves=false),
  computeWeightedComplexity(ratios, useLCM, useGCD, gcdWeight),
  eulerGradus(n, d),
  
  // Utils
  ratioToCents(r),
  getNoteName(midi)
}
```

------

## TODO (по приоритету)

### Высокий

1. **Динамическое окно (realtime)**
   - Decay factor для нот со временем
   - 60 FPS обновление
   - Режимы: instant / smooth / sticky
2. **Звук**
   - Синтез JI интервалов
   - A/B сравнение с 12-EDO

### Средний

1. **Оптимизации**
   - Инкрементальный LCM/GCD (кэширование)
   - Web Worker для тяжёлых расчётов
   - Профилирование при 10+ нотах
2. **Расширенная аналитика**
   - Prime limit аккорда
   - Comma detection (синтонические, септимальные)
   - Export интерпретации

### Низкий

1. UX polish
   - Hover tooltips с центами
   - Keyboard shortcuts
   - Preset аккорды для демо

------

## Конфигурация (defaults)

JavaScript



```
BEAM_WIDTH = 50
MAX_CANDS = 6
VISUAL_GHOSTS = 3
CENTS_THRESHOLD = 35
PRIME_LIMIT = 7
gcdWeight = 1.5
hysteresis = 0.2
maxOdd = 45
```